import{j as e,m as Ne,U as Ce,B as Se,S as ke,V as _e,C as Ie,T as Ee,R as Me,P as Ae,M as Pe,W as $e,a as Te,b as De}from"./ui.D-SKQn5i.js";import{r,a as Re}from"./vendor.CzzjzYca.js";import{I as D,B as q}from"./Button.CP0jvIJM.js";import{S as M,s as ne}from"./StorageService.Dv_ujdX7.js";import{M as ze,r as Le}from"./index.BI_XnwRa.js";import{G as Ge}from"./GlassLayout.2i7s6xei.js";import{C as Oe}from"./ContentReader.nO1touE1.js";import"./utils.BNe0Xlio.js";import"./preload-helper.CRk0x-X1.js";const We=({isOpen:a=!1,onToggle:C,activeConversationId:u=null,onSelectConversation:g,onNewConversation:v,onDeleteConversation:S,className:j=""})=>{const[l,i]=r.useState(""),[f,A]=r.useState([]);r.useEffect(()=>{a&&(async()=>{try{const o=await M.get("conversations_index",[]);Array.isArray(o)&&A(o)}catch(o){console.error("Sidebar load failed",o)}})()},[a]);const h=f==null?void 0:f.filter(s=>{var o,_,y,I;return((_=(o=s==null?void 0:s.title)==null?void 0:o.toLowerCase())==null?void 0:_.includes(l==null?void 0:l.toLowerCase()))||((I=(y=s==null?void 0:s.preview)==null?void 0:y.toLowerCase())==null?void 0:I.includes(l==null?void 0:l.toLowerCase()))}),d=s=>{const o=new Date(s),y=new Date-o,I=Math.floor(y/6e4),E=Math.floor(y/36e5),T=Math.floor(y/864e5);return I<1?"Just now":I<60?`${I}m ago`:E<24?`${E}h ago`:T<7?`${T}d ago`:o==null?void 0:o.toLocaleDateString()};return e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:C,className:"fixed top-20 left-4 z-[150] lg:hidden p-2 rounded-md bg-card border border-border elevation-md transition-base hover:bg-muted","aria-label":"Toggle conversation sidebar",children:e.jsx(D,{name:a?"X":"MessageSquare",size:20})}),a&&e.jsx("div",{className:"fixed inset-0 z-[140] bg-background lg:hidden",onClick:C}),e.jsx("aside",{className:`
        fixed top-16 left-0 h-[calc(100vh-4rem)] w-80 z-[145]
        bg-card border-r border-border
        transition-transform duration-250 ease-out
        ${a?"translate-x-0":"-translate-x-full"}
        lg:translate-x-0
        ${j}
      `,children:e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 border-b border-border",children:[e.jsx("h2",{className:"text-lg font-heading font-semibold text-foreground",children:"Conversations"}),e.jsx(q,{variant:"ghost",size:"icon",iconName:"Plus",onClick:v,className:"h-8 w-8"})]}),e.jsx("div",{className:"p-4 border-b border-border",children:e.jsxs("div",{className:"relative",children:[e.jsx(D,{name:"Search",size:18,className:"absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground"}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:l,onChange:s=>{var o;return i((o=s==null?void 0:s.target)==null?void 0:o.value)},className:"w-full pl-10 pr-4 py-2 bg-muted border border-border rounded-md text-sm text-foreground placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 transition-base"})]})}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:(h==null?void 0:h.length)===0?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[e.jsx(D,{name:"MessageSquare",size:48,className:"text-muted-foreground mb-4"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l?"No conversations found":"No conversations yet"})]}):e.jsx("div",{className:"flex flex-col",children:h==null?void 0:h.map(s=>e.jsxs("button",{onClick:()=>{g(s==null?void 0:s.id),window.innerWidth<1024&&C()},className:`
                      group relative flex flex-col gap-1 p-4 text-left border-b border-border
                      transition-base hover:bg-muted
                      ${u===(s==null?void 0:s.id)?"bg-muted":""}
                    `,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2",children:[e.jsx("h3",{className:"text-sm font-caption font-medium text-foreground line-clamp-1",children:s==null?void 0:s.title}),e.jsx("span",{className:"text-xs text-muted-foreground whitespace-nowrap",children:d(s==null?void 0:s.timestamp)})]}),(s==null?void 0:s.preview)&&e.jsx("p",{className:"text-xs text-muted-foreground line-clamp-2 pr-6",children:s==null?void 0:s.preview}),e.jsx("button",{onClick:o=>{o.stopPropagation(),window.confirm("Delete this chat?")&&S(s.id)},className:"absolute right-2 top-1/2 -translate-y-1/2 p-2 opacity-0 group-hover:opacity-100 hover:text-red-500 transition-opacity",title:"Delete Chat",children:e.jsx(D,{name:"Trash2",size:14})}),(s==null?void 0:s.messageCount)&&e.jsxs("div",{className:"flex items-center gap-1 mt-1",children:[e.jsx(D,{name:"MessageCircle",size:12,className:"text-muted-foreground"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[s==null?void 0:s.messageCount," messages"]})]})]},s==null?void 0:s.id))})})]})})]})},ae=({agentType:a="planner",activity:C="",progress:u=0,status:g="active",details:v=[]})=>{var f,A;const[S,j]=Re.useState(!1),l={planner:{name:"Planner Agent",icon:"Brain",color:"text-neon-cyan",bgColor:"bg-black/80 shadow-[inset_0_0_10px_rgba(6,182,212,0.2)]",borderColor:"border-neon-cyan/40"},navigator:{name:"Navigator Agent",icon:"Navigation",color:"text-neon-blue",bgColor:"bg-black/80 shadow-[inset_0_0_10px_rgba(59,130,246,0.2)]",borderColor:"border-neon-blue/40"},validator:{name:"Validator Agent",icon:"CheckCircle2",color:"text-neon-green",bgColor:"bg-black/80 shadow-[inset_0_0_10px_rgba(34,197,94,0.2)]",borderColor:"border-neon-green/40"},generating_image:{name:"Image Agent",icon:"Image",color:"text-neon-magenta",bgColor:"bg-black/80 shadow-[inset_0_0_10px_rgba(236,72,153,0.2)]",borderColor:"border-neon-magenta/40"}},i=(l==null?void 0:l[a])||(l==null?void 0:l.planner);return e.jsxs("div",{className:`
      p-4 md:p-5 rounded-lg border ${i==null?void 0:i.borderColor} ${i==null?void 0:i.bgColor}
      transition-all duration-300
    `,children:[e.jsxs("div",{className:"flex items-start gap-3 md:gap-4 mb-3",children:[e.jsx("div",{className:`
          flex-shrink-0 w-10 h-10 md:w-12 md:h-12 rounded-lg flex items-center justify-center
          ${i==null?void 0:i.bgColor} border ${i==null?void 0:i.borderColor}
        `,children:e.jsx(D,{name:i==null?void 0:i.icon,size:24,className:i==null?void 0:i.color})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[e.jsx("h3",{className:`text-sm md:text-base font-caption font-semibold ${i==null?void 0:i.color}`,children:i==null?void 0:i.name}),e.jsxs("div",{className:"flex items-center gap-2",children:[g==="active"&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("div",{className:`w-2 h-2 rounded-full ${(f=i==null?void 0:i.color)==null?void 0:f.replace("text-","bg-")} animate-pulse`}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Active"})]}),e.jsx("button",{onClick:()=>j(!S),className:"p-1 hover:bg-black/5 rounded-full transition-colors",children:e.jsx(D,{name:S?"ChevronUp":"ChevronDown",size:16,className:"text-muted-foreground"})})]})]}),e.jsx("p",{className:"text-sm text-foreground line-clamp-2",children:C})]})]}),u>0&&e.jsxs("div",{className:"mb-3",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1.5",children:[e.jsx("span",{className:"text-xs font-caption text-muted-foreground",children:"Progress"}),e.jsxs("span",{className:"text-xs font-caption font-medium text-foreground",children:[u,"%"]})]}),e.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full ${(A=i==null?void 0:i.bgColor)==null?void 0:A.replace("/10","")} transition-all duration-300`,style:{width:`${u}%`}})})]}),(v==null?void 0:v.length)>0&&S&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-black/5 space-y-2 animate-in slide-in-from-top-2 duration-200",children:[e.jsx("div",{className:"text-xs font-semibold text-muted-foreground mb-2",children:"Thinking Process:"}),v==null?void 0:v.map((h,d)=>e.jsxs("div",{className:"flex items-start gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{className:"mt-0.5",children:"â€¢"}),e.jsx("span",{className:"break-words",children:h})]},d))]})]})},re=({plan:a,onApprove:C,onReject:u})=>a?e.jsxs("div",{className:"border border-border rounded-lg bg-card p-4 my-4 shadow-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3 pb-3 border-b border-border",children:[e.jsx(D,{name:"Map",size:18,className:"text-primary"}),e.jsx("h3",{className:"font-semibold text-sm text-foreground",children:"Proposed Execution Plan"})]}),e.jsx("div",{className:"space-y-3 mb-4",children:a.steps&&a.steps.map((g,v)=>e.jsxs("div",{className:"flex gap-3 text-sm",children:[e.jsx("div",{className:"flex-shrink-0 w-6 h-6 rounded-full bg-muted flex items-center justify-center text-xs font-medium text-muted-foreground",children:v+1}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-foreground font-medium",children:g.description}),g.url&&e.jsx("p",{className:"text-xs text-muted-foreground font-mono mt-0.5",children:g.url})]})]},v))}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(q,{variant:"default",size:"sm",className:"flex-1 bg-green-600 hover:bg-green-700 text-white",onClick:C,iconName:"Check",children:"Approve Plan"}),e.jsx(q,{variant:"outline",size:"sm",className:"flex-1 text-destructive border-destructive/30 hover:bg-destructive/10",onClick:u,iconName:"X",children:"Reject"})]})]}):null,Be=({message:a,onRetry:C,onEdit:u})=>{var O,z;const g=a.role==="user";a.role;const[v,S]=r.useState(!1),[j,l]=r.useState(a.content),[i,f]=r.useState(null);r.useEffect(()=>{l(a.content)},[a.content]);const A=()=>{u&&j.trim()!==a.content&&u(j),S(!1)},[h,d]=r.useState(!1),s=r.useRef(null),o=b=>{if(!b)return"";let x=b;return x=x.replace(/```[\s\S]*?```/g,"Code snippet provided."),x=x.replace(/`([^`]+)`/g,"$1"),x=x.replace(/\[([^\]]+)\]\([^\)]+\)/g,"$1"),x=x.replace(/(https?:\/\/[^\s]+)/g,"Link"),x=x.replace(/[*_]{1,3}([^*_]+)[*_]{1,3}/g,"$1"),x=x.replace(/^#+\s+/gm,""),x=x.replace(/#(\w+)/g,"$1"),x=x.replace(/^>\s+/gm,""),x=x.replace(/\s+/g," ").trim(),x};r.useEffect(()=>()=>{s.current&&window.speechSynthesis.cancel()},[]);const _=()=>{if(h){window.speechSynthesis.cancel(),d(!1);return}const b=typeof a.content=="string"?a.content:"",x=o(b)||"Content not available for speech.",N=new SpeechSynthesisUtterance(x),W=window.speechSynthesis.getVoices().find(P=>P.name.includes("Zira")||P.name.includes("Google US English")||P.name.includes("Samantha")||P.name.toLowerCase().includes("female"));W&&(N.voice=W,W.name.includes("Zira")||(N.pitch=1.1)),N.onend=()=>{d(!1),s.current=null},N.onerror=()=>{d(!1),s.current=null},s.current=N,window.speechSynthesis.speak(N),d(!0)},y=(b,x)=>{b.stopPropagation();const N=document.createElement("a");N.href=x,N.download=`generated-image-${Date.now()}.png`,document.body.appendChild(N),N.click(),document.body.removeChild(N)},I=({src:b,alt:x})=>e.jsxs("div",{className:"relative group/image my-2 inline-block max-w-full",children:[e.jsx("img",{src:b,alt:x,className:"max-w-full rounded-lg shadow-lg border border-white/10 cursor-pointer",style:{maxHeight:"300px",objectFit:"contain"},loading:"lazy",onClick:()=>f(b)}),e.jsxs("div",{className:"absolute top-2 right-2 flex gap-1 opacity-0 group-hover/image:opacity-100 transition-opacity bg-black/60 rounded-lg p-1 backdrop-blur-sm",children:[e.jsx("button",{onClick:N=>y(N,b),className:"p-1.5 hover:bg-white/20 rounded text-white transition-colors",title:"Download",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",x2:"12",y1:"15",y2:"3"})]})}),e.jsx("button",{onClick:()=>f(b),className:"p-1.5 hover:bg-white/20 rounded text-white transition-colors",title:"View Fullscreen",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"14",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("polyline",{points:"15 3 21 3 21 9"}),e.jsx("polyline",{points:"9 21 3 21 3 15"}),e.jsx("line",{x1:"21",x2:"14",y1:"3",y2:"10"}),e.jsx("line",{x1:"3",x2:"10",y1:"21",y2:"14"})]})})]})]}),E=g?"border-neon-blue/40":"border-neon-cyan/40",T=g?"bg-slate-900/60 shadow-[inset_0_0_20px_rgba(59,130,246,0.1)]":"bg-black/70 shadow-[inset_0_0_20px_rgba(6,182,212,0.1)]",R={hidden:{opacity:0,y:10,scale:.95},visible:{opacity:1,y:0,scale:1}};return e.jsxs(e.Fragment,{children:[e.jsx(Ne.div,{initial:"hidden",animate:"visible",variants:R,transition:{duration:.3,ease:"backOut"},className:`flex w-full mb-4 ${g?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`
                relative max-w-[85%] rounded-2xl p-4 group
                ${T} backdrop-blur-md 
                border ${E}
                shadow-[0_4px_16px_rgba(0,0,0,0.2)]
                ${g?"rounded-tr-none shadow-[0_0_15px_rgba(59,130,246,0.1)]":"rounded-tl-none shadow-[0_0_15px_rgba(6,182,212,0.1)]"}
            `,children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-2 pb-2 border-b border-white/5 opacity-80 group-hover:opacity-100 transition-opacity",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[g?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-[10px] font-mono text-neon-blue/70",children:"COMMANDER"}),e.jsx(Ce,{className:"w-3 h-3 text-neon-blue"})]}):e.jsxs(e.Fragment,{children:[e.jsx(Se,{className:"w-3 h-3 text-neon-cyan"}),e.jsx("span",{className:"text-[10px] font-mono text-neon-cyan/70",children:"CORE SYSTEM"})]}),a.timestamp&&e.jsx("span",{className:"text-[10px] text-gray-400 ml-2 font-mono",children:new Date(a.timestamp).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]}),!v&&e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx("button",{onClick:_,className:`p-1 hover:bg-white/10 rounded transition-colors ${h?"text-neon-cyan animate-pulse":"text-white/50 hover:text-white"}`,title:h?"Stop Speaking":"Read Aloud",children:h?e.jsx(ke,{size:12,fill:"currentColor"}):e.jsx(_e,{size:12})}),e.jsx("button",{onClick:()=>navigator.clipboard.writeText(typeof a.content=="string"?a.content:""),className:"p-1 hover:bg-white/10 rounded transition-colors text-white/50 hover:text-white",title:"Copy",children:e.jsx(Ie,{size:12})}),g&&e.jsx("button",{onClick:()=>S(!0),className:"p-1 hover:bg-white/10 rounded transition-colors text-white/50 hover:text-white",title:"Edit",children:e.jsx(Ee,{size:12})}),e.jsx("button",{onClick:()=>C&&C(),className:"p-1 hover:bg-white/10 rounded transition-colors text-white/50 hover:text-white",title:"Regenerate",children:e.jsx(Me,{size:12})})]})]}),e.jsx("div",{className:`text-sm ${g?"text-white font-body":"text-gray-100 font-body"}`,children:v?e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("textarea",{value:j,onChange:b=>l(b.target.value),className:"w-full bg-black/50 border border-white/10 rounded-lg p-2 text-white outline-none focus:border-neon-cyan/50 min-h-[60px]",autoFocus:!0}),e.jsxs("div",{className:"flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>S(!1),className:"text-xs px-2 py-1 bg-white/5 hover:bg-white/10 rounded text-gray-300",children:"Cancel"}),e.jsx("button",{onClick:A,className:"text-xs px-2 py-1 bg-neon-cyan/20 hover:bg-neon-cyan/30 text-neon-cyan border border-neon-cyan/50 rounded",children:"Save & Submit"})]})]}):e.jsxs(e.Fragment,{children:[a.content&&typeof a.content=="string"?e.jsx("div",{className:"prose prose-invert prose-sm max-w-none prose-p:leading-relaxed prose-pre:bg-black/50 prose-pre:border prose-pre:border-white/10",children:e.jsx(ze,{remarkPlugins:[Le],components:{img:({node:b,...x})=>e.jsx(I,{src:x.src,alt:x.alt})},children:a.content})}):typeof a.content=="object"?JSON.stringify(a.content,null,2):String(a.content),((O=a.metadata)==null?void 0:O.type)==="agent_activity"&&e.jsx("div",{className:"mt-3",children:e.jsx(ae,{activity:a.metadata.activity,status:a.metadata.status||"in_progress"})}),((z=a.metadata)==null?void 0:z.type)==="implementation_plan_review"&&e.jsx("div",{className:"mt-3",children:e.jsx(re,{plan:a.metadata.plan})})]})}),!v&&e.jsx("div",{className:`absolute bottom-0 ${g?"right-0 w-1/3":"left-0 w-1/3"} h-[1px] bg-gradient-to-r from-transparent via-${g?"neon-blue":"neon-cyan"} to-transparent opacity-50`})]})}),i&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/95 backdrop-blur-md p-4 animate-in fade-in duration-200",onClick:()=>f(null),children:e.jsxs("div",{className:"relative max-w-full max-h-full flex items-center justify-center",children:[e.jsx("img",{src:i,alt:"Extended View",className:"max-w-full max-h-[90vh] rounded-lg shadow-2xl object-contain",onClick:b=>b.stopPropagation()}),e.jsx("button",{onClick:()=>f(null),className:"absolute -top-12 right-0 p-2 text-white/70 hover:text-white bg-black/50 rounded-full",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})}),e.jsx("button",{onClick:b=>y(b,i),className:"absolute -top-12 right-12 p-2 text-white/70 hover:text-white mr-2 bg-black/50 rounded-full",children:e.jsxs("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"}),e.jsx("polyline",{points:"7 10 12 15 17 10"}),e.jsx("line",{x1:"12",x2:"12",y1:"15",y2:"3"})]})})]})})]})},Ve=({onSendMessage:a,disabled:C,value:u,onChange:g,onVoiceToggle:v,isRecording:S,attachments:j=[],onRemoveAttachment:l,onAddAttachments:i,isProcessing:f,onStop:A,onPlusClick:h,onEnhance:d,isEnhancing:s})=>{const o=r.useRef(null);r.useEffect(()=>{o.current&&(o.current.style.height="auto",o.current.style.height=`${Math.min(o.current.scrollHeight,120)}px`)},[u]);const _=y=>{y.key==="Enter"&&!y.shiftKey&&(y.preventDefault(),(u.trim()||j.length>0)&&a({text:u,attachments:j}))};return e.jsxs("div",{className:"relative w-full px-2 pb-2",children:[e.jsxs("div",{className:`
                relative flex items-end gap-2 p-2 
                rounded-2xl border transition-all duration-300
                glass-panel
                ${S?"border-red-500/50 shadow-[0_0_15px_rgba(239,68,68,0.2)]":"border-neon-cyan/30 hover:border-neon-cyan/60 hover:shadow-[0_0_15px_rgba(6,182,212,0.1)]"}
            `,children:[e.jsx("button",{onClick:h,className:"p-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-neon-cyan transition-colors",title:"Add content",children:e.jsx(Ae,{size:18})}),e.jsxs("div",{className:"flex-1 flex flex-col min-w-0",children:[j.length>0&&e.jsx("div",{className:"flex gap-2 mb-2 overflow-x-auto py-1 px-1",children:j.map((y,I)=>e.jsxs("div",{className:"flex items-center gap-1.5 bg-white/10 px-2 py-1 rounded text-xs text-white border border-white/10",children:[e.jsx("span",{className:"truncate max-w-[80px]",children:y.name}),e.jsx("button",{onClick:()=>l(I),className:"hover:text-red-400",children:"Ã—"})]},I))}),e.jsx("textarea",{ref:o,value:u,onChange:y=>g(y.target.value),onKeyDown:_,placeholder:S?"Listening...":"Command the agent...",disabled:C,rows:1,className:"w-full bg-transparent border-none text-sm text-white placeholder-gray-400 focus:ring-0 resize-none py-2.5 max-h-[120px]"})]}),e.jsxs("div",{className:"flex items-end gap-1",children:[e.jsx("button",{onClick:v,className:`p-2.5 rounded-xl transition-all duration-300 ${S?"text-red-500 bg-red-500/10 animate-pulse":"text-gray-400 hover:text-white hover:bg-white/5"}`,title:"Voice Input",children:e.jsx(Pe,{size:18})}),d&&e.jsx("button",{onClick:d,disabled:!u||u.trim().length===0||s,className:`p-2.5 rounded-xl transition-all duration-300 ${s?"text-neon-magenta animate-pulse":"text-gray-400 hover:text-neon-magenta hover:bg-neon-magenta/10"}`,title:"Enhance Prompt (AI)",children:e.jsx($e,{size:18})}),f?e.jsx("button",{onClick:A,className:"p-2.5 rounded-xl bg-red-500/80 hover:bg-red-600 text-white shadow-lg transition-all hover:scale-105",children:e.jsx(Te,{size:18,className:"animate-pulse"})}):e.jsx("button",{onClick:()=>{(u.trim()||j.length>0)&&a({text:u,attachments:j})},disabled:!u.trim()&&j.length===0,className:`
                                p-2.5 rounded-xl transition-all duration-300 transform
                                ${u.trim()||j.length>0?"bg-neon-cyan text-black shadow-[0_0_15px_rgba(6,182,212,0.4)] hover:scale-105 hover:bg-cyan-300":"bg-white/5 text-gray-500 cursor-not-allowed"}
                            `,children:e.jsx(De,{size:18})})]})]}),e.jsx("div",{className:"absolute -bottom-1 left-4 right-4 h-[1px] bg-gradient-to-r from-transparent via-neon-cyan/50 to-transparent blur-[2px]"})]})},Fe=({isOpen:a,onClose:C,onFileUpload:u,isImageGenEnabled:g,toggleImageGen:v,isWebSearchEnabled:S,toggleWebSearch:j,isShoppingMode:l,toggleShopping:i,isAgenticMode:f,toggleAgentic:A})=>{if(!a)return null;const h=[{icon:"Paperclip",label:"Add photos & files",onClick:u,color:"text-neon-blue"},{icon:"Palette",label:"Create image",onClick:v,active:g,color:"text-neon-magenta"},{icon:"Globe",label:"Deep research",onClick:j,active:S,color:"text-neon-cyan"},{icon:"ShoppingBag",label:"Shopping research",onClick:i,active:l,color:"text-green-400"},{icon:"Zap",label:"Agent Mode",onClick:A,active:f,color:"text-neon-violet"}];return e.jsxs("div",{className:"absolute bottom-16 left-2 z-50 animate-in fade-in zoom-in-95 slide-in-from-bottom-2 duration-200",children:[e.jsx("div",{className:"glass-panel border border-neon-cyan/30 rounded-xl shadow-[0_0_20px_rgba(0,0,0,0.5)] w-64 overflow-hidden backdrop-blur-xl",children:e.jsx("div",{className:"p-1.5 space-y-0.5",children:h.map((d,s)=>e.jsxs("button",{onClick:()=>{d.onClick(),C()},className:`
                                w-full flex items-center gap-3 px-3 py-2.5 text-sm rounded-lg transition-all duration-200 group
                                ${d.active?"bg-neon-cyan/10 text-white shadow-[0_0_10px_rgba(6,182,212,0.2)] border border-neon-cyan/20":"text-gray-300 hover:bg-white/5 hover:text-white hover:pl-4"}
                            `,children:[e.jsx("span",{className:`${d.color} ${d.active?"opacity-100":"opacity-80 group-hover:opacity-100"} transition-opacity`,children:e.jsx(D,{name:d.icon,size:18,className:d.active?"animate-pulse":""})}),e.jsx("span",{className:"flex-1 text-left font-body tracking-wide",children:d.label}),d.active&&e.jsx("span",{className:"w-1.5 h-1.5 rounded-full bg-neon-cyan shadow-[0_0_5px_theme('colors.neon.cyan')]"})]},s))})}),e.jsx("div",{className:"fixed inset-0 z-[-1]",onClick:C})]})},st=()=>{const[a,C]=r.useState(null),[u,g]=r.useState(!0),[v,S]=r.useState(!1),[j,l]=r.useState("idle"),[i,f]=r.useState(""),[A,h]=r.useState(0),[d,s]=r.useState("conv-1"),[o,_]=r.useState([]),[y,I]=r.useState([]),[E,T]=r.useState(null),[R,O]=r.useState(!1),[z,b]=r.useState(""),[x,N]=r.useState([]),[H,W]=r.useState(!1),[P,oe]=r.useState(!1),[ie,le]=r.useState(75),[ce,Ue]=r.useState(12),L=r.useRef(null),J=r.useRef(null);r.useEffect(()=>{ne.auth.getSession().then(({data:{session:n}})=>{C(n),g(!1)});const{data:{subscription:t}}=ne.auth.onAuthStateChange((n,c)=>{C(c)});return()=>t.unsubscribe()},[]),r.useEffect(()=>{if(!a)return;(async()=>{const n=await M.get("conversations_index",[]);if(I(n),sessionStorage.getItem("nova_session_active")){const p=await M.get("last_active_conversation_id"),$=n.some(m=>m.id===p);if(p&&$){s(p);return}}const w=`conv-${Date.now()}`;s(w),sessionStorage.setItem("nova_session_active","true")})()},[a]),r.useEffect(()=>{M.set("last_active_conversation_id",d)},[d]),r.useEffect(()=>{(async()=>{const n=await M.get(`conversation_${d}`,[]);_(n)})()},[d]),r.useEffect(()=>{o.length>0&&(M.set(`conversation_${d}`,o),M.get("conversations_index",[]).then(t=>{var $,m,F;const n=t.filter(k=>k.id!==d);let c="New Conversation";const w=t.find(k=>k.id===d);if(w&&w.title!=="New Conversation")c=w.title;else if(o.length>0){const k=o.find(G=>G.sender==="user");k&&(c=k.message.slice(0,35)+(k.message.length>35?"...":""))}const p={id:d,title:c,lastMessage:($=o[o.length-1])==null?void 0:$.message,timestamp:new Date().toISOString(),messageCount:o.length,preview:(F=(m=o[o.length-1])==null?void 0:m.message)==null?void 0:F.slice(0,100)};M.set("conversations_index",[p,...n])}))},[o,d]),r.useEffect(()=>{(async()=>{const n=await M.get("conversations_index",[]);I(n)})()},[o]);const de=()=>{var t;L!=null&&L.current&&(L.current.scrollTop=(t=L==null?void 0:L.current)==null?void 0:t.scrollHeight)};r.useEffect(()=>{de()},[o,E,j]),r.useEffect(()=>{if(typeof chrome<"u"&&chrome.runtime){const t=n=>{if(n.type==="AGENT_PROGRESS"){const{status:c,message:w,result:p,plan:$}=n.data;if(c==="thinking"?(l("thinking"),f(w)):c==="planning"?(l("planning"),f(w),h(25)):c==="waiting_approval"?(l("waiting_approval"),f("Waiting for plan approval"),_(m=>[...m,{id:Date.now(),sender:"system",type:"plan_review",plan:$,timestamp:new Date}])):c==="navigating"?(l("navigating"),f(w),h(50)):c==="validating"?(l("validating"),f(w),h(85)):c==="generating_image"?(l("generating_image"),f(w),h(60)):(c==="idle"||c==="completed")&&(l("idle"),f(""),h(100),c==="completed"&&le(m=>Math.min(m+15,100))),["planning","navigating","validating","generating_image"].includes(c)&&T(m=>({agentType:c,activity:w,progress:c==="planning"?25:c==="navigating"?50:c==="generating_image"?60:90,status:"active",details:m?[...m.details||[],w]:[w]})),(c==="idle"||c==="completed")&&p){let m=p.summary||p.message||"Task completed successfully";if(p.images&&p.images.length>0){const k=p.images.map(G=>`![Generated Image](${typeof G=="object"?G.url||G.image_url||G.data:G})`).join(`

`);m=`${m}

${k}`}const F={id:Date.now()+1,sender:"agent",message:m,timestamp:new Date,agentStatus:null,images:p.images};_(k=>[...k,F]),T(null),l("idle"),h(0)}}};return chrome.runtime.onMessage.addListener(t),()=>chrome.runtime.onMessage.removeListener(t)}},[]);const[B,Y]=r.useState(!1),[V,Q]=r.useState(!1),[ee,K]=r.useState(!1),[me,te]=r.useState(!1),U=r.useRef(null),X=r.useRef(""),xe=async()=>{if(!("webkitSpeechRecognition"in window)){alert("Speech recognition not supported");return}try{await navigator.mediaDevices.getUserMedia({audio:!0});const t=new window.webkitSpeechRecognition;t.continuous=!0,t.interimResults=!0,X.current=z,t.onresult=n=>{let c="",w="";for(let m=n.resultIndex;m<n.results.length;++m)n.results[m].isFinal?w+=n.results[m][0].transcript:c+=n.results[m][0].transcript;let p="";for(let m=0;m<n.results.length;++m)p+=n.results[m][0].transcript;const $=X.current.length>0?" ":"";b(X.current+$+p)},t.onerror=n=>{console.error("Speech Error: "+n.error),se(),n.error==="not-allowed"&&alert("Microphone permission denied.")},U.current=t,t.start(),K(!0)}catch(t){console.error("Failed to start recording",t),K(!1)}},se=()=>{U.current&&(U.current.stop(),U.current=null),K(!1)},ue=()=>{ee?se():xe()},Z=async({text:t,attachments:n})=>{const c={id:Date.now(),sender:"user",message:t,timestamp:new Date,attachments:n};_(m=>[...m,c]),b(""),N([]);const w=await Oe.read(n),p=w?`${t}

[Attached Content]:
${w}`:t,$=o.slice(-10).map(m=>({role:m.sender==="user"?"user":"assistant",content:m.message}));if(typeof chrome<"u"&&chrome.runtime){if(!(await M.get("llm_providers",[])).some(k=>k.isEnabled&&k.apiKey&&k.apiKey.trim().length>0)){_(k=>[...k,{id:Date.now(),sender:"system",message:`âš ï¸ **Missing API Key**

Please go to **Settings** (âš™ï¸) and configure an LLM Provider (e.g., TypeGPT, OpenAI) to start chatting.`,timestamp:new Date}]),l("idle");return}if(P&&(B||V||R)){alert("Please turn off Agent Modes (Web, Shopping, Agent) to use Image Generation.");return}chrome.runtime.sendMessage({type:"START_AGENT_TASK",prompt:p,history:$,isAgentic:R,isWebSearchEnabled:B,isShoppingMode:V,isImageGen:P}),l("thinking")}},pe=()=>{chrome.runtime.sendMessage({type:"APPROVE_PLAN"}),l("navigating")},he=()=>{chrome.runtime.sendMessage({type:"REJECT_PLAN"}),l("idle"),_(t=>[...t,{id:Date.now(),sender:"system",message:"Plan rejected.",timestamp:new Date}])},ge=async t=>{const n=y.filter(c=>c.id!==t);if(I(n),await M.set("conversations_index",n),await M.remove(`conversation_${t}`),t===d)if(n.length>0)s(n[0].id);else{const c=`conv-${Date.now()}`;s(c)}},fe=()=>{chrome.runtime.sendMessage({type:"STOP_AGENT"}),l("idle"),T(null),_(t=>[...t,{id:Date.now(),sender:"system",message:"ðŸ›‘ Task stopped by user.",timestamp:new Date}])},be=()=>{_([]);const t=`conv-${Date.now()}`;s(t),T(null),l("idle"),I(n=>[{id:t,title:"New Conversation",timestamp:new Date().toISOString()},...n])},we=t=>{s(t),S(!1)},ve=t=>{const n=[...o].reverse().find(c=>c.sender==="user");n&&Z({text:n.message,attachments:n.attachments||[]})},je=t=>{t&&Z({text:t,attachments:[]})},ye=async()=>{if(!(!z||z.trim().length===0)){te(!0);try{const t=await chrome.runtime.sendMessage({type:"ENHANCE_PROMPT",prompt:z});t&&t.enhancedPrompt&&b(t.enhancedPrompt)}catch(t){console.error("Enhancement failed",t)}finally{te(!1)}}};return u?e.jsx("div",{className:"h-full bg-black flex items-center justify-center text-neon-cyan font-mono animate-pulse",children:"SYSTEM INITIALIZING..."}):e.jsx(Ge,{level:ce,xp:ie,children:e.jsxs("div",{className:"flex-1 flex flex-col h-full overflow-hidden relative",children:[e.jsx("div",{ref:L,className:"flex-1 overflow-y-auto px-1 py-4 scroll-smooth",children:e.jsxs("div",{className:"max-w-4xl mx-auto pb-4 min-h-full flex flex-col justify-end",children:[o.length===0&&e.jsx("div",{className:"flex-1 flex flex-col justify-center items-center opacity-70",children:e.jsx("div",{className:"text-neon-cyan font-heading text-2xl tracking-[0.3em] animate-pulse drop-shadow-[0_0_15px_rgba(6,182,212,0.8)] opacity-100 font-bold",children:"SYSTEM ONLINE"})}),o.map(t=>e.jsx("div",{className:"mb-2 w-full",children:t.type==="plan_review"?e.jsx(re,{plan:t.plan,onApprove:pe,onReject:he}):e.jsx(Be,{message:{role:t.sender==="user"?"user":"assistant",content:t.message,timestamp:t.timestamp,metadata:t.agentStatus?{type:"agent_activity",activity:t.agentStatus,status:"active"}:void 0},isLast:!0,onRetry:()=>ve(o.indexOf(t)),onEdit:n=>je(n)})},t.id)),E&&e.jsx("div",{className:"mb-6",children:e.jsx(ae,{agentType:E.agentType,activity:E.activity,progress:E.progress,status:E.status,details:E.details})})]})}),e.jsxs("div",{className:"flex-shrink-0 pt-2 pb-1 relative z-30",children:[e.jsx(Fe,{isOpen:H,onClose:()=>W(!1),onFileUpload:()=>{var t;return(t=J.current)==null?void 0:t.click()},isImageGenEnabled:P,toggleImageGen:()=>{if(!a)return alert("Please Log In.");oe(!P)},isWebSearchEnabled:B,toggleWebSearch:()=>{if(!a)return alert("Please Log In.");Y(!B),B||O(!1)},isShoppingMode:V,toggleShopping:()=>{if(!a)return alert("Please Log In.");Q(!V),V||O(!1)},isAgenticMode:R,toggleAgentic:()=>{if(!a)return alert("Please Log In.");O(!R),R||(Y(!1),Q(!1))}}),e.jsx("input",{type:"file",multiple:!0,ref:J,className:"hidden",onChange:t=>{var n;if((n=t.target.files)!=null&&n.length){const w=Array.from(t.target.files).map(p=>({name:p.name,type:p.type.startsWith("image/")?"image":"document",size:p.size,file:p}));N(p=>[...p,...w]),t.target.value=""}}}),e.jsxs("div",{className:"flex gap-2 mb-2 px-2 overflow-x-auto no-scrollbar",children:[P&&e.jsx("span",{className:"text-[9px] font-mono px-2 py-0.5 rounded border border-neon-blue text-neon-blue bg-neon-blue/10",children:"IMG GEN"}),B&&e.jsx("span",{className:"text-[9px] font-mono px-2 py-0.5 rounded border border-neon-cyan text-neon-cyan bg-neon-cyan/10",children:"WEB SEARCH"}),V&&e.jsx("span",{className:"text-[9px] font-mono px-2 py-0.5 rounded border border-neon-magenta text-neon-magenta bg-neon-magenta/10",children:"SHOPPING"}),R&&e.jsx("span",{className:"text-[9px] font-mono px-2 py-0.5 rounded border border-neon-violet text-neon-violet bg-neon-violet/10",children:"AGENTIC"})]}),e.jsx(Ve,{onSendMessage:Z,disabled:j!=="idle",value:z,onChange:b,onVoiceToggle:ue,isRecording:ee,onEnhance:ye,isEnhancing:me,attachments:x,onAddAttachments:t=>N(n=>[...n,...t]),onRemoveAttachment:t=>N(n=>n.filter((c,w)=>w!==t)),isProcessing:j!=="idle",onStop:fe,onPlusClick:()=>W(!H)})]}),e.jsx(We,{isOpen:v,onToggle:()=>S(!v),conversations:y,activeConversationId:d,onSelectConversation:we,onNewConversation:be,onDeleteConversation:ge})]})})};export{st as default};
